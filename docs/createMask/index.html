



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-0.17.2, mkdocs-material-2.6.0">
    
    
      
        <title>Creating Masks - Pyneal Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.aa3de92b.css">
      
    
    
      <script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <a href="#creating-masks" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Pyneal Docs" class="md-header-nav__button md-logo">
          
            <i class="md-icon">home</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Pyneal Docs
              </span>
              <span class="md-header-nav__topic">
                Creating Masks
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <i class="md-icon">home</i>
      
    </span>
    Pyneal Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Getting Started
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Getting Started
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../installation/" title="Installation" class="md-nav__link">
      Installation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../setup/" title="Setup" class="md-nav__link">
      Setup
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../quickOverview/" title="Quick Overview" class="md-nav__link">
      Quick Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../pynealScanner/" title="Pyneal Scanner" class="md-nav__link">
      Pyneal Scanner
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../pyneal/" title="Pyneal" class="md-nav__link">
      Pyneal
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../simulations/" title="Simulations" class="md-nav__link">
      Simulations
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7" checked>
    
    <label class="md-nav__link" for="nav-7">
      Additional Tools
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Additional Tools
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Creating Masks
      </label>
    
    <a href="./" title="Creating Masks" class="md-nav__link md-nav__link--active">
      Creating Masks
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#launching-createmask" title="Launching createMask" class="md-nav__link">
    Launching createMask
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#specifying-a-reference-4d-functional-file" title="Specifying a reference 4D functional file" class="md-nav__link">
    Specifying a reference 4D functional file
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deciding-on-a-mask-type" title="Deciding on a mask type" class="md-nav__link">
    Deciding on a mask type
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#whole-brain-mask" title="Whole Brain Mask" class="md-nav__link">
    Whole Brain Mask
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transform-mni-space-mask" title="Transform MNI space mask" class="md-nav__link">
    Transform MNI space mask
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#output-files" title="Output files" class="md-nav__link">
    Output files
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../customAnalysis/" title="Customized Analyses" class="md-nav__link">
      Customized Analyses
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../troubleshooting/" title="Troubleshooting" class="md-nav__link">
      Troubleshooting
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      Reference
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        Reference
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../glossary/" title="Glossary" class="md-nav__link">
      Glossary
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../imageOrientation/" title="Image Orientation" class="md-nav__link">
      Image Orientation
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#launching-createmask" title="Launching createMask" class="md-nav__link">
    Launching createMask
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#specifying-a-reference-4d-functional-file" title="Specifying a reference 4D functional file" class="md-nav__link">
    Specifying a reference 4D functional file
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deciding-on-a-mask-type" title="Deciding on a mask type" class="md-nav__link">
    Deciding on a mask type
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#whole-brain-mask" title="Whole Brain Mask" class="md-nav__link">
    Whole Brain Mask
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transform-mni-space-mask" title="Transform MNI space mask" class="md-nav__link">
    Transform MNI space mask
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#output-files" title="Output files" class="md-nav__link">
    Output files
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="creating-masks">Creating Masks<a class="headerlink" href="#creating-masks" title="Permanent link">&para;</a></h1>
<p><strong>Pyneal</strong> requires that you input a mask for use during real-time analysis. This mask must have the same voxel dimensions and image orientation as the incoming functional data.</p>
<p>Depending on your real-time analysis needs, one option could be to create a functional ROI by collecting a localizer task run and quickly analyzing it during your scanning session. </p>
<p>Alternatively, you may wish to focus your analysis on predefined anatomical ROIs. In this case, you need to transform an anatomical mask from a standard space (like MNI) to match the functional data of your participant in the scanner.  </p>
<p>The <code>createMask.py</code> tool will assist you in quickly creating whole-brain or anatomical masks during a real-time session. </p>
<p><strong>createMask</strong> provides you with two mask creation options:</p>
<ul>
<li>
<p><strong>Whole Brain Mask</strong>: This option will create a whole brain mask from the functional data you supply. </p>
</li>
<li>
<p><strong>Transform mask from MNI space</strong>: This option will take a mask defined in MNI space and transform it to the dimensions and orientation of the functional data you supply.</p>
</li>
</ul>
<p><em>Note:</em> Behind the scenes, createMask.py relies on various functions from FSL. Make sure you have installed <a href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki"><strong>FSL 5.0</strong></a></p>
<h2 id="launching-createmask">Launching createMask<a class="headerlink" href="#launching-createmask" title="Permanent link">&para;</a></h2>
<p>The createMask tool is found in <code>pyneal/utils/createMask.py</code></p>
<p>You can launch the createMask GUI by navigating to the <code>utils</code> directory via the terminal and running <code>createMask.py</code> with Python</p>
<blockquote>
<p>cd utils<br />
python createMask.py</p>
</blockquote>
<p><img alt="" src="../images/createMaskGUI.png" /></p>
<h2 id="specifying-a-reference-4d-functional-file">Specifying a reference 4D functional file<a class="headerlink" href="#specifying-a-reference-4d-functional-file" title="Permanent link">&para;</a></h2>
<p>In order to create masks, we need to know the voxel size, 3D volume dimensions, and image orientation of the functional data for the current session. The easiest way to get this data is to include a brief (30sec or less) functional scan near the beginning of your session. Use the exact same slice prescriptions and image settings as you plan to use during your real-time scans. </p>
<p>After the scan has finished, use the <code>getSeries.py</code> tool from <strong>Pyneal Scanner</strong> to convert the images to a 4D nifti file. Note that <code>getSeries.py</code> will automatically reorient the output data to RAS+ orientation. Thus, by using this data as our reference functional data we will create a mask that is also in RAS+. This is good since, during a real-time run, <strong>Pyneal</strong> will be receiving data in RAS+ orientation (see <a href="../imageOrientation/"><strong>image orientation</strong></a> for more info) </p>
<p><code>createMask.py</code> will create an example 3D functional image for reference by taking the mean across time of the specified 4D functional. </p>
<h2 id="deciding-on-a-mask-type">Deciding on a mask type<a class="headerlink" href="#deciding-on-a-mask-type" title="Permanent link">&para;</a></h2>
<h3 id="whole-brain-mask">Whole Brain Mask<a class="headerlink" href="#whole-brain-mask" title="Permanent link">&para;</a></h3>
<p>If you check <strong>Create whole-brain FUNC mask</strong>, a 3D whole-brain mask will be created using the 4D FUNC file as a reference. Every brain voxel will be labeled <strong>1</strong> and every non-brain voxel will be labeled <strong>0</strong>.</p>
<p>The output file will be found in <code>mask_transforms/FUNC_masks/wholeBrain_FUNC_mask.nii.gz</code></p>
<p>A whole-brain mask is useful in situations where you are using a custom analysis during real-time runs and want access to the entire 3D brain volume (e.g. calculating grand volume mean as a reference value for other steps in your analysis). </p>
<h3 id="transform-mni-space-mask">Transform MNI space mask<a class="headerlink" href="#transform-mni-space-mask" title="Permanent link">&para;</a></h3>
<p>More commonly, your real-time analysis may focus on activation in one or more predefined regions of interest (ROIs). Before beginning your real-time run, you need to create a mask(s) of your desired ROI(s) that match the resolution and orientation of the participant's functional data. </p>
<p><code>createMask.py</code> offers a way to quickly transform a mask from MNI space to the required functional space. To do so, the following intermediate steps take place:</p>
<ul>
<li>a transformation matrix is created mapping from MNI space to the participant's high-res anatomical image (<code>mni2hires.mat</code>)</li>
<li>a transformation matrix is created mapping from the participant's high-resolution anatomical image to the participant's functional data (<code>hires2func.mat</code>)  </li>
<li>a 3rd tranformation matrix is created by concatenating the previous two matrices in order to create a transformation mapping from MNI space to functional space (<code>mni2func.mat</code>) </li>
</ul>
<p>The resulting <code>mni2func.mat</code> matrix is used to transform the specifed MNI-space mask to functional space. </p>
<p>Specify the following input to <code>createMask.py</code> when selecting <strong>Transform MNI mask to FUNC</strong>:</p>
<ul>
<li><strong>hi-res ANAT</strong>: path to participant's high-resolution anatomical image, collected during the current scanning session</li>
<li><strong>MNI-standard</strong>: path to the MNI standard. This standard must be in the same space as the mask you wish to transform. For instance, if your mask is in MNI space with a resolution of 1mm, you must select the MNI152_T1_1mm standard image. Sample MNI standard images can be found in <code>pyneal/utils/MNI_templates</code></li>
<li><strong>MNI mask</strong>: The mask file you wish to transform</li>
<li><strong>Output Prefix:</strong>: The output prefix that will be prepended to the transformed masks. </li>
</ul>
<p>Once you hit <strong>Submit</strong>, <code>createMask.py</code> will go about creating the necessary intermediate tranforms. Once complete, the new masks will open automatically in FSLeyes so that you may confirm that everything completed correctly. </p>
<p><img alt="" src="../images/createMask_fsleyes.png" /></p>
<p>The new masks (and intermedate files) will be saved to the output directory. </p>
<h2 id="output-files">Output files<a class="headerlink" href="#output-files" title="Permanent link">&para;</a></h2>
<p>The output from <code>createMask.py</code> will be saved to the same directory as the specified reference 4D file. Within that directory, you will find a new directory named <code>mask_transforms</code> that holds all of the output mask files and transformation matrices from <code>createMask.py</code></p>
<p>Depending on the type of mask you are creating, you will find some set of the following files:</p>
<ul>
<li><code>FUNC_masks/wholeBrain_FUNC_mask.nii.gz</code>: whole brain mask in participant functional space</li>
<li><code>FUNC_masks/&lt;outputPrefix&gt;_FUNC_mask.nii.gz</code>: binarized version of the transformed MNI mask in participant functional space</li>
<li><code>FUNC_masks/&lt;outputPrefix&gt;_FUNC_weighted.nii.gz</code>: non-binarized version of the transformed MNI mask in participant functional space. If the MNI mask you used represents a probabilistic atlas, for instance, those voxel probabilities will be preserved in this file. </li>
<li><code>exampleFunc.nii.gz</code>: a 3D functional image created by averaging the input 4D FUNC file</li>
<li><code>hires_brain.nii.gz</code>: skull-stripped version of the input hi-res ANAT file</li>
<li><code>hires_FUNC.nii.gz</code>: hi-res anatomical image transformed to participant functional space</li>
<li><code>mni_HIRES.nii.gz</code>: MNI standard transformed to participant hi-res anatomical space</li>
<li><code>hires2func.mat</code>: transformation matrix mapping from hi-res anatomical space to participant functional space</li>
<li><code>mni2hires.mat</code>: transformation matrix mapping from MNI space to hi-res anatomical space</li>
<li><code>mni2func.mat</code>: transformation matrix mapping from MNI space to participant functional space</li>
<li><code>maskTransforms.log</code>: log file detailing all of the steps that were carried out</li>
</ul>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../simulations/" title="Simulations" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Simulations
              </span>
            </div>
          </a>
        
        
          <a href="../customAnalysis/" title="Customized Analyses" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Customized Analyses
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
      <a href="https://github.com/jeffmacinnes/pyneal" class="md-footer-social__link fa fa-github"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.9fb73e57.js"></script>
      
      <script>app.initialize({version:"0.17.2",url:{base:".."}})</script>
      
    
    
      
    
  </body>
</html>